/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "usb_device.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "commhandler.h"
#include "usbd_cdc_if.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
CRC_HandleTypeDef hcrc;

I2C_HandleTypeDef hi2c1;

I2S_HandleTypeDef hi2s3;

RNG_HandleTypeDef hrng;

SPI_HandleTypeDef hspi1;

/* USER CODE BEGIN PV */
uint8_t messageCounter = 1;
uint8_t dataReceivedFlag = 0;
uint8_t receiveBuffer[2000];
uint16_t receiveCounter = 0;
uint8_t sendBuffer[2500];
uint16_t sendCounter = 0;
const unsigned char tokenCert[] = {
		0x30,0x82,0x03,0x47,0x30,0x82,0x02,0x2f,0x02,0x14,0x6c,0xb5,0x5b,0xfc,0x6c,0x8a,
		0xd1,0xbe,0xd9,0xfb,0x6f,0x06,0xd3,0x68,0x33,0x38,0xe8,0x1b,0xc7,0x08,0x30,0x0d,
		0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x0b,0x05,0x00,0x30,0x5e,0x31,
		0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,0x53,0x4b,0x31,0x0f,0x30,0x0d,
		0x06,0x03,0x55,0x04,0x08,0x0c,0x06,0x4b,0x6f,0x73,0x69,0x63,0x65,0x31,0x0f,0x30,
		0x0d,0x06,0x03,0x55,0x04,0x07,0x0c,0x06,0x4b,0x6f,0x73,0x69,0x63,0x65,0x31,0x0d,
		0x30,0x0b,0x06,0x03,0x55,0x04,0x0a,0x0c,0x04,0x55,0x50,0x4a,0x53,0x31,0x11,0x30,
		0x0f,0x06,0x03,0x55,0x04,0x0b,0x0c,0x08,0x64,0x69,0x70,0x6c,0x6f,0x6d,0x6b,0x61,
		0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x03,0x0c,0x02,0x43,0x41,0x30,0x1e,0x17,
		0x0d,0x32,0x35,0x30,0x38,0x31,0x39,0x31,0x36,0x34,0x37,0x35,0x36,0x5a,0x17,0x0d,
		0x32,0x37,0x31,0x31,0x32,0x32,0x31,0x36,0x34,0x37,0x35,0x36,0x5a,0x30,0x62,0x31,
		0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,0x53,0x4b,0x31,0x0f,0x30,0x0d,
		0x06,0x03,0x55,0x04,0x08,0x0c,0x06,0x4b,0x6f,0x73,0x69,0x63,0x65,0x31,0x0f,0x30,
		0x0d,0x06,0x03,0x55,0x04,0x07,0x0c,0x06,0x4b,0x6f,0x73,0x69,0x63,0x65,0x31,0x21,
		0x30,0x1f,0x06,0x03,0x55,0x04,0x0a,0x0c,0x18,0x49,0x6e,0x74,0x65,0x72,0x6e,0x65,
		0x74,0x20,0x57,0x69,0x64,0x67,0x69,0x74,0x73,0x20,0x50,0x74,0x79,0x20,0x4c,0x74,
		0x64,0x31,0x0e,0x30,0x0c,0x06,0x03,0x55,0x04,0x03,0x0c,0x05,0x74,0x6f,0x6b,0x65,
		0x6e,0x30,0x82,0x01,0x22,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,
		0x01,0x01,0x05,0x00,0x03,0x82,0x01,0x0f,0x00,0x30,0x82,0x01,0x0a,0x02,0x82,0x01,
		0x01,0x00,0x9b,0x86,0x6f,0x54,0x33,0xe2,0x80,0xca,0x05,0x8f,0xa9,0xd4,0xec,0x40,
		0x1f,0x84,0x76,0x74,0x01,0x02,0xc4,0xd3,0xdd,0xa3,0xeb,0xfa,0xf2,0xe4,0xf0,0xa4,
		0x5c,0xd8,0x17,0xd9,0xb6,0x61,0x38,0xda,0x6f,0x64,0xc2,0xd1,0xb7,0x0b,0xba,0xb3,
		0x18,0x85,0x61,0x04,0x64,0xec,0x26,0xd2,0xf4,0x59,0xc0,0x25,0xa4,0x41,0xa8,0x25,
		0xbc,0xfe,0x74,0xcc,0x37,0x5e,0x8c,0xc6,0x2d,0xdb,0x4b,0xc8,0x4e,0xb3,0xd2,0x83,
		0x5c,0x44,0xbd,0x07,0x26,0x09,0xeb,0x2a,0x66,0x5d,0x81,0xd4,0x0c,0x16,0xc6,0x50,
		0x1f,0xca,0x97,0xf8,0x61,0x6d,0x80,0x3b,0x07,0x69,0x47,0x71,0xe7,0x5c,0x3a,0x97,
		0x22,0x30,0x4e,0x5c,0xec,0x49,0x50,0x21,0x2e,0x52,0x4d,0x9a,0x7b,0x6b,0x03,0xbf,
		0x8e,0x61,0x60,0xc9,0x79,0x52,0x3b,0x91,0xcc,0xc9,0x79,0xb3,0xdc,0xec,0xc2,0xd0,
		0xb5,0x8c,0x0e,0xc6,0x79,0xdd,0xd2,0xc8,0xb9,0x2e,0xc6,0x9f,0x41,0x29,0x36,0xb5,
		0x18,0x68,0x88,0xbf,0xc1,0x24,0x7b,0xf7,0x46,0x52,0x0d,0x14,0x39,0xbd,0xae,0x83,
		0x11,0x43,0x1a,0x9d,0x4b,0x07,0xda,0xac,0x84,0xba,0x69,0x92,0x50,0x5e,0x54,0x74,
		0x47,0x1d,0x25,0xcb,0x2a,0x6c,0x1c,0xfa,0x57,0x7d,0x67,0xb4,0xa6,0xb8,0x85,0x1f,
		0xfe,0x9e,0x6e,0xae,0x11,0x44,0x95,0xd4,0xa3,0x65,0x52,0x62,0x9d,0x61,0xab,0xca,
		0x79,0x79,0x3e,0x6e,0xac,0xef,0x3f,0x3a,0xec,0x41,0x56,0xe8,0xe6,0x33,0xb4,0x89,
		0x9f,0xb7,0x97,0x40,0x6c,0x72,0x1b,0x54,0x81,0xc3,0xdc,0xef,0x05,0xd7,0x66,0x33,
		0x89,0x71,0x02,0x03,0x01,0x00,0x01,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,
		0x0d,0x01,0x01,0x0b,0x05,0x00,0x03,0x82,0x01,0x01,0x00,0x73,0x19,0x96,0xce,0x0d,
		0x5e,0xa1,0x92,0xb8,0x26,0x40,0x8d,0x4b,0x92,0x4b,0xb9,0x6d,0x35,0xe8,0xcf,0x38,
		0xe8,0x58,0xaf,0xb6,0x0e,0x18,0xad,0xf1,0x9e,0x76,0x42,0x73,0x52,0x26,0x1a,0xec,
		0x2c,0xc3,0xb3,0x33,0x37,0x19,0xca,0x75,0xd3,0x97,0x66,0xf7,0x49,0x60,0xa9,0xbe,
		0xae,0x06,0x28,0xd3,0x14,0xbb,0x59,0xba,0x7c,0x4b,0x2e,0x96,0x7a,0x16,0x73,0xf6,
		0xf3,0x3d,0x38,0xd1,0xde,0xb5,0x3f,0x84,0x77,0xb4,0xe2,0xbb,0xc5,0x47,0x64,0x98,
		0x1d,0x96,0xa7,0x9a,0x45,0x78,0xfb,0xa3,0xf1,0xa4,0x44,0x2e,0x9d,0xec,0xe0,0x1d,
		0x47,0x1b,0x86,0x7c,0x54,0xe9,0x5a,0x3a,0xa1,0xf8,0xa7,0x78,0x89,0x3c,0xf5,0x8e,
		0x35,0xb1,0x9e,0x4d,0x09,0xef,0x79,0xb5,0x79,0xaf,0x66,0x34,0x19,0xa0,0x9f,0x7c,
		0x8c,0x5f,0xdc,0x19,0x4a,0xe3,0x00,0x88,0xbe,0xd3,0x87,0x8a,0xe9,0x1b,0xb1,0xe4,
		0xbe,0x51,0xe2,0x9b,0x88,0xad,0x02,0xfc,0xec,0xf7,0xc6,0x14,0xf0,0x7e,0xcc,0x1c,
		0xe2,0xf3,0xab,0x51,0xd9,0xa0,0x9a,0xe8,0xcb,0x2d,0x80,0x18,0x54,0x7d,0x27,0xb4,
		0xa4,0x66,0xde,0x63,0x82,0xd9,0xcc,0xa7,0x80,0xc0,0x80,0xc1,0xc9,0xba,0xd8,0xd6,
		0x16,0xb0,0x25,0x2c,0xff,0xa1,0x35,0x32,0x6e,0x0a,0x66,0xb7,0x61,0x82,0x1d,0xdf,
		0x15,0xcb,0x9c,0x1b,0xd5,0x25,0x01,0xb3,0x53,0xfa,0xd0,0x5f,0x35,0x17,0x26,0x96,
		0x72,0x9d,0x44,0x16,0x6a,0x3b,0xbd,0xa6,0x7f,0x55,0x31,0xcd,0x8c,0xb5,0x03,0xab,
		0x7b,0x67,0x8e,0x9a,0x9c,0xb1,0x8c,0x6b,0x14,0x4d,0xab
};
const uint16_t tokenCertLen = sizeof(tokenCert);
const unsigned char tokenPrivKey[] = {
		0x30,0x82,0x04,0xbc,0x02,0x01,0x00,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,
		0x0d,0x01,0x01,0x01,0x05,0x00,0x04,0x82,0x04,0xa6,0x30,0x82,0x04,0xa2,0x02,0x01,
		0x00,0x02,0x82,0x01,0x01,0x00,0x9b,0x86,0x6f,0x54,0x33,0xe2,0x80,0xca,0x05,0x8f,
		0xa9,0xd4,0xec,0x40,0x1f,0x84,0x76,0x74,0x01,0x02,0xc4,0xd3,0xdd,0xa3,0xeb,0xfa,
		0xf2,0xe4,0xf0,0xa4,0x5c,0xd8,0x17,0xd9,0xb6,0x61,0x38,0xda,0x6f,0x64,0xc2,0xd1,
		0xb7,0x0b,0xba,0xb3,0x18,0x85,0x61,0x04,0x64,0xec,0x26,0xd2,0xf4,0x59,0xc0,0x25,
		0xa4,0x41,0xa8,0x25,0xbc,0xfe,0x74,0xcc,0x37,0x5e,0x8c,0xc6,0x2d,0xdb,0x4b,0xc8,
		0x4e,0xb3,0xd2,0x83,0x5c,0x44,0xbd,0x07,0x26,0x09,0xeb,0x2a,0x66,0x5d,0x81,0xd4,
		0x0c,0x16,0xc6,0x50,0x1f,0xca,0x97,0xf8,0x61,0x6d,0x80,0x3b,0x07,0x69,0x47,0x71,
		0xe7,0x5c,0x3a,0x97,0x22,0x30,0x4e,0x5c,0xec,0x49,0x50,0x21,0x2e,0x52,0x4d,0x9a,
		0x7b,0x6b,0x03,0xbf,0x8e,0x61,0x60,0xc9,0x79,0x52,0x3b,0x91,0xcc,0xc9,0x79,0xb3,
		0xdc,0xec,0xc2,0xd0,0xb5,0x8c,0x0e,0xc6,0x79,0xdd,0xd2,0xc8,0xb9,0x2e,0xc6,0x9f,
		0x41,0x29,0x36,0xb5,0x18,0x68,0x88,0xbf,0xc1,0x24,0x7b,0xf7,0x46,0x52,0x0d,0x14,
		0x39,0xbd,0xae,0x83,0x11,0x43,0x1a,0x9d,0x4b,0x07,0xda,0xac,0x84,0xba,0x69,0x92,
		0x50,0x5e,0x54,0x74,0x47,0x1d,0x25,0xcb,0x2a,0x6c,0x1c,0xfa,0x57,0x7d,0x67,0xb4,
		0xa6,0xb8,0x85,0x1f,0xfe,0x9e,0x6e,0xae,0x11,0x44,0x95,0xd4,0xa3,0x65,0x52,0x62,
		0x9d,0x61,0xab,0xca,0x79,0x79,0x3e,0x6e,0xac,0xef,0x3f,0x3a,0xec,0x41,0x56,0xe8,
		0xe6,0x33,0xb4,0x89,0x9f,0xb7,0x97,0x40,0x6c,0x72,0x1b,0x54,0x81,0xc3,0xdc,0xef,
		0x05,0xd7,0x66,0x33,0x89,0x71,0x02,0x03,0x01,0x00,0x01,0x02,0x82,0x01,0x00,0x49,
		0xd8,0x37,0x95,0x1d,0xfb,0x9e,0x96,0x0d,0xb4,0xec,0x79,0x16,0x61,0xcd,0xf5,0x39,
		0xbf,0x13,0xd9,0xca,0x36,0x24,0xa7,0x57,0xfd,0x34,0x06,0x43,0x42,0x6f,0x79,0x05,
		0x3e,0x10,0xcc,0x31,0xcf,0xf9,0x93,0x38,0xb3,0x95,0xbb,0xa2,0x7e,0xb6,0x16,0x62,
		0x7d,0xd1,0x23,0x95,0xbd,0x95,0x5a,0xe6,0x12,0x99,0x5e,0xb9,0x65,0x8d,0xca,0xae,
		0x0f,0x66,0xfc,0xe4,0x4f,0x96,0xe7,0x68,0xa0,0xa7,0xc9,0xd7,0x1b,0x1b,0x1c,0xe2,
		0x39,0xfa,0x34,0x3c,0x6e,0x49,0xe3,0x7d,0x28,0xff,0x42,0x73,0x10,0x09,0x40,0x4b,
		0x0f,0x1a,0xc7,0x80,0xda,0xc6,0x46,0x95,0x2f,0x3e,0xa0,0xba,0x8b,0x17,0x27,0x23,
		0x96,0x18,0x75,0x28,0xf0,0x50,0x4b,0xb0,0xe0,0x38,0x58,0x94,0x13,0x88,0x98,0xf3,
		0x74,0xd3,0xee,0x3f,0x8a,0xbf,0x05,0x66,0x69,0x3a,0xae,0x0f,0xbc,0x06,0x1d,0x0a,
		0xeb,0x39,0xfa,0xc1,0x5e,0x21,0x9a,0xf8,0x3c,0x62,0x85,0xbf,0x99,0x31,0x48,0x7a,
		0xf3,0xfa,0xe6,0x45,0xf6,0x3c,0x5f,0x4a,0x25,0x55,0x14,0x2d,0x2a,0xda,0xee,0x2c,
		0xe7,0xe2,0xb8,0x33,0xc9,0x21,0x86,0xa9,0x7a,0x5f,0x0b,0xd5,0x74,0xec,0xd1,0xe2,
		0x25,0x52,0xef,0x02,0x2f,0xb4,0x3a,0xfd,0x15,0xe5,0x90,0xc0,0x5d,0xc5,0x81,0x83,
		0x57,0xa7,0x11,0x9b,0xcd,0x9c,0xa1,0xae,0x18,0x4f,0xec,0x8d,0x2a,0x22,0xf1,0x3b,
		0x89,0x30,0x39,0xb3,0xb9,0x49,0x6f,0x81,0x4e,0x60,0xac,0xb6,0x00,0xd1,0xac,0x04,
		0x42,0x0d,0x9c,0x8b,0x58,0x94,0xba,0x22,0x05,0x64,0x61,0xd8,0x2d,0x4e,0x1f,0x02,
		0x81,0x81,0x00,0xc3,0xe2,0xe3,0x5c,0x89,0x4b,0xd8,0x9e,0xbb,0xd3,0x71,0x44,0x3d,
		0x48,0x52,0xf4,0x42,0x92,0xec,0x92,0x9c,0xf9,0x33,0xd2,0x0c,0x35,0xdb,0x53,0xb3,
		0x6b,0x48,0xe0,0x64,0xf1,0x63,0xf4,0x6c,0x94,0x2c,0x83,0x62,0x23,0x96,0x4d,0x8f,
		0xaf,0x12,0xff,0x87,0xf4,0x05,0x8e,0x09,0xdf,0x60,0x02,0x6a,0x1e,0x49,0x19,0x78,
		0x43,0x89,0x7e,0x7b,0xee,0xcf,0x76,0x31,0x8a,0xa0,0x38,0x6e,0xa3,0x3d,0x5a,0xba,
		0x67,0xe3,0x87,0xc6,0xc5,0x47,0x08,0x0d,0x5e,0xe0,0x80,0x6b,0xae,0x79,0x8c,0x55,
		0x92,0x6c,0xff,0x21,0xe5,0xe1,0x5f,0xe3,0x58,0x09,0x84,0x2a,0xa4,0xd5,0xc5,0x2c,
		0x76,0xa6,0xf5,0xb1,0x18,0x24,0x89,0xda,0xb8,0x88,0x70,0x86,0xd4,0x5f,0x7c,0x32,
		0xd4,0xf1,0x6b,0x02,0x81,0x81,0x00,0xcb,0x40,0xb7,0x60,0x70,0xbd,0xf8,0x9b,0xb7,
		0xc9,0xa5,0xd5,0x11,0x17,0xc6,0xdd,0xa2,0xa9,0x60,0xcf,0xaa,0x0c,0x96,0xdd,0x34,
		0x5f,0x50,0x49,0x67,0x68,0x6c,0x82,0xf9,0xbe,0x0d,0x23,0x59,0xc8,0x61,0x13,0x99,
		0xc2,0xe1,0xfd,0xb1,0xde,0xfa,0xba,0xf2,0x40,0xc2,0x9a,0x14,0xd7,0xd8,0x13,0x1f,
		0x75,0xab,0x61,0x99,0xc7,0xe7,0x3c,0xae,0x7f,0xbf,0xaf,0x08,0x21,0x48,0x0f,0x9b,
		0x4d,0x95,0xfb,0xd0,0x7b,0x5e,0x27,0xe3,0x6a,0xc8,0x9f,0x30,0xdc,0xca,0x8b,0xfe,
		0xda,0x8f,0x31,0xfd,0xc7,0x46,0x15,0x2c,0x02,0x80,0x62,0x36,0xde,0x98,0x14,0xeb,
		0x39,0xa0,0xe8,0x4c,0xde,0x7d,0xb1,0x5e,0x22,0x2d,0x78,0x27,0x3a,0x72,0xa0,0x02,
		0x43,0x84,0x85,0x70,0xeb,0xfb,0x93,0x02,0x81,0x80,0x04,0xa7,0x5e,0x49,0x73,0x85,
		0x96,0xc6,0xe6,0xa5,0x76,0x5a,0x6d,0xae,0x4b,0x32,0x3c,0x66,0xab,0x32,0x2c,0x82,
		0x8b,0x25,0xa1,0x5e,0xa2,0x30,0x51,0xe1,0xe9,0xa0,0x53,0x25,0x9c,0xff,0x50,0x99,
		0x10,0x99,0xaa,0x7a,0x37,0xf6,0xed,0xc3,0xf6,0x0a,0x96,0x1b,0x49,0x0a,0x7f,0xd7,
		0x8b,0xbb,0x62,0xf4,0x07,0x3e,0x90,0xa9,0xe2,0x19,0x5c,0x2e,0x67,0x45,0x62,0x95,
		0xed,0x8a,0x89,0xae,0x5d,0x25,0xcb,0xa9,0xee,0x30,0xea,0x9b,0x03,0x3e,0x00,0xbb,
		0x51,0x50,0x1b,0xbe,0xd0,0x6a,0x72,0x1a,0x01,0x76,0xea,0x42,0x40,0xe1,0x7b,0x50,
		0x3b,0x21,0xa5,0xb5,0xb6,0xd2,0x71,0x64,0xfc,0x40,0x78,0x0d,0x9f,0xc8,0x9a,0xa6,
		0xa9,0xaf,0x2a,0xb4,0xde,0xf3,0xdf,0x6d,0x49,0xb3,0x02,0x81,0x80,0x10,0xf9,0x41,
		0x97,0x23,0x33,0x2a,0x2c,0xce,0xe7,0x5f,0x1a,0xf1,0x07,0x7c,0x4b,0x0c,0x07,0x7b,
		0x17,0x3c,0x8b,0x3a,0x9a,0x14,0x82,0x95,0x30,0xdc,0x1a,0xe3,0x5c,0xf8,0xc0,0x3f,
		0x56,0xa1,0x6b,0xd3,0x77,0x90,0x92,0xae,0xce,0xc1,0xe8,0xee,0x25,0x68,0x8f,0xb1,
		0xf0,0xae,0x26,0xec,0x5b,0x84,0x78,0x0e,0x2c,0xe3,0x6b,0xc7,0x4a,0xd1,0x03,0xc8,
		0x1d,0x34,0xdf,0x9a,0xa5,0xfb,0x01,0x3a,0xb2,0x41,0xd1,0xdb,0xa6,0x17,0x1e,0xd6,
		0xcc,0x3c,0x87,0x63,0xbe,0xd7,0x34,0xa7,0x5a,0xb4,0x67,0xcc,0xd9,0x7d,0xc8,0x63,
		0xb2,0x50,0x04,0xbc,0xcc,0x9a,0x6c,0x40,0x9c,0xc5,0xb6,0x9a,0xe6,0x92,0x06,0xe6,
		0xa7,0x2f,0x17,0x79,0x75,0x15,0x5b,0x50,0x18,0xd8,0xba,0x4c,0x53,0x02,0x81,0x80,
		0x01,0xc5,0x79,0x43,0x4c,0x89,0xed,0xd3,0xd0,0xaf,0x1a,0xfd,0xd6,0xbb,0xce,0xbd,
		0x1a,0xe7,0xa8,0x09,0x6c,0xfe,0x21,0x94,0x4c,0x2c,0x03,0xbb,0x22,0xbb,0x74,0x4c,
		0xf5,0xc3,0x9a,0xd8,0x28,0x82,0x72,0xc7,0xa7,0x24,0x5f,0xbb,0x89,0x46,0x2e,0x3f,
		0x3c,0x36,0x52,0x2b,0x60,0x0e,0x98,0xd8,0x02,0x8a,0x6b,0x90,0x2a,0x95,0x8c,0x6b,
		0xa3,0xce,0x2a,0x83,0xab,0x81,0xc2,0x2f,0x46,0x3e,0x9a,0x25,0x61,0xcf,0xc9,0xae,
		0xcb,0xc5,0xdb,0xc6,0x59,0x23,0x48,0x72,0x85,0xda,0x46,0x06,0x2e,0x6c,0xab,0x70,
		0x38,0xe5,0x4e,0xdf,0x16,0x05,0x5e,0xda,0x32,0x37,0xa1,0x74,0xdb,0x01,0xbf,0x8c,
		0xd9,0x92,0xa0,0x80,0x9b,0xb2,0x07,0x06,0xa4,0x31,0x4c,0xfc,0xb5,0x0a,0x41,0x2d
};
const uint16_t tokenPrivKeyLen = sizeof(tokenPrivKey);
const unsigned char CACert[] = {
		0x30,0x82,0x03,0x9d,0x30,0x82,0x02,0x85,0xa0,0x03,0x02,0x01,0x02,0x02,0x14,0x24,
		0x82,0x73,0x6a,0x59,0xfa,0x10,0xa8,0x4e,0xb4,0xe6,0xb6,0x50,0x90,0xf8,0x39,0x7e,
		0xe7,0x0e,0xff,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x0b,
		0x05,0x00,0x30,0x5e,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,0x53,
		0x4b,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x08,0x0c,0x06,0x4b,0x6f,0x73,0x69,
		0x63,0x65,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x07,0x0c,0x06,0x4b,0x6f,0x73,
		0x69,0x63,0x65,0x31,0x0d,0x30,0x0b,0x06,0x03,0x55,0x04,0x0a,0x0c,0x04,0x55,0x50,
		0x4a,0x53,0x31,0x11,0x30,0x0f,0x06,0x03,0x55,0x04,0x0b,0x0c,0x08,0x64,0x69,0x70,
		0x6c,0x6f,0x6d,0x6b,0x61,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x03,0x0c,0x02,
		0x43,0x41,0x30,0x1e,0x17,0x0d,0x32,0x35,0x30,0x38,0x31,0x39,0x31,0x36,0x34,0x31,
		0x35,0x33,0x5a,0x17,0x0d,0x33,0x30,0x30,0x38,0x31,0x38,0x31,0x36,0x34,0x31,0x35,
		0x33,0x5a,0x30,0x5e,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,0x53,
		0x4b,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x08,0x0c,0x06,0x4b,0x6f,0x73,0x69,
		0x63,0x65,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x07,0x0c,0x06,0x4b,0x6f,0x73,
		0x69,0x63,0x65,0x31,0x0d,0x30,0x0b,0x06,0x03,0x55,0x04,0x0a,0x0c,0x04,0x55,0x50,
		0x4a,0x53,0x31,0x11,0x30,0x0f,0x06,0x03,0x55,0x04,0x0b,0x0c,0x08,0x64,0x69,0x70,
		0x6c,0x6f,0x6d,0x6b,0x61,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x03,0x0c,0x02,
		0x43,0x41,0x30,0x82,0x01,0x22,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,
		0x01,0x01,0x01,0x05,0x00,0x03,0x82,0x01,0x0f,0x00,0x30,0x82,0x01,0x0a,0x02,0x82,
		0x01,0x01,0x00,0xa7,0xf4,0xe1,0x26,0xaf,0xfb,0x89,0x2b,0x0b,0xbd,0x14,0x13,0xda,
		0xd7,0x04,0xd4,0xf8,0x35,0x96,0xfc,0x83,0xc8,0x39,0x02,0x1f,0x41,0x16,0x4e,0xf1,
		0x27,0x41,0xa2,0x13,0x8b,0x61,0xe6,0xc7,0x43,0x1e,0xed,0xfc,0x2a,0x77,0xba,0x46,
		0x98,0xe2,0x7b,0xa0,0x80,0x65,0x1c,0xa5,0x4a,0x5c,0xbe,0x9d,0x2f,0x02,0x57,0xf2,
		0x9a,0x80,0xbd,0x6f,0xe6,0xba,0x90,0x6a,0x01,0xd3,0xa2,0xc3,0xe2,0x5e,0xdd,0xe0,
		0x11,0x39,0x67,0x3d,0xe1,0x07,0xc7,0xb9,0xbe,0x4f,0x0c,0x36,0x72,0xa3,0x0b,0x54,
		0xeb,0x1a,0xb9,0x11,0xd9,0x62,0xb0,0x81,0xfa,0x60,0x0c,0x5a,0x97,0x5f,0x46,0x73,
		0x3d,0x8e,0x29,0x9a,0x83,0x2e,0xb7,0x8d,0x35,0x49,0xa6,0x7d,0x49,0xbc,0x65,0xd8,
		0x6d,0x01,0x80,0xff,0x82,0xa8,0xd8,0x9f,0x37,0x78,0x44,0xac,0x42,0xe6,0x5c,0xfa,
		0x8b,0xa4,0x4c,0xb0,0x03,0xa3,0x19,0xf2,0x65,0xfd,0x0f,0xc9,0xad,0x92,0x33,0x41,
		0xa6,0x7c,0x0f,0x59,0x65,0x25,0xd6,0xa8,0xe5,0x20,0x12,0x45,0xa9,0xa5,0xe1,0x9c,
		0x99,0x9a,0x17,0x69,0xae,0x32,0x44,0xca,0x0c,0xcc,0x65,0x2f,0xca,0xfc,0x39,0x07,
		0x3a,0x32,0xcd,0x73,0xb9,0x03,0xe2,0xde,0x98,0x12,0x7d,0x52,0xd8,0x87,0x05,0x82,
		0x58,0xb0,0x10,0xcc,0xe5,0xc0,0x38,0x17,0xdd,0xdc,0x63,0xa9,0x2d,0xe3,0xee,0x29,
		0x25,0x16,0x30,0x2c,0x8e,0x60,0x9a,0x78,0x89,0x24,0xf1,0x5a,0xc4,0x40,0x7e,0x9d,
		0xa9,0xab,0xd4,0xce,0xf3,0xcb,0xcb,0xb3,0x83,0xf5,0xc8,0x23,0x0c,0x5f,0x4b,0xa2,
		0x6e,0x28,0xbf,0x02,0x03,0x01,0x00,0x01,0xa3,0x53,0x30,0x51,0x30,0x1d,0x06,0x03,
		0x55,0x1d,0x0e,0x04,0x16,0x04,0x14,0xc2,0x53,0x15,0x07,0x71,0xe2,0x37,0x7e,0x7f,
		0x84,0xc1,0x12,0xdd,0x9a,0x50,0xd7,0x2d,0x24,0xd0,0x54,0x30,0x1f,0x06,0x03,0x55,
		0x1d,0x23,0x04,0x18,0x30,0x16,0x80,0x14,0xc2,0x53,0x15,0x07,0x71,0xe2,0x37,0x7e,
		0x7f,0x84,0xc1,0x12,0xdd,0x9a,0x50,0xd7,0x2d,0x24,0xd0,0x54,0x30,0x0f,0x06,0x03,
		0x55,0x1d,0x13,0x01,0x01,0xff,0x04,0x05,0x30,0x03,0x01,0x01,0xff,0x30,0x0d,0x06,
		0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x0b,0x05,0x00,0x03,0x82,0x01,0x01,
		0x00,0x1e,0x9d,0x6c,0xe6,0xb4,0x2e,0x46,0x54,0xea,0x12,0xf4,0xb2,0xf3,0x8c,0x0e,
		0xc5,0xb0,0x61,0x40,0x37,0x51,0xff,0x71,0xd0,0xc8,0x37,0xdb,0x68,0x8d,0x39,0xec,
		0xc0,0xe7,0x20,0x09,0x97,0xcc,0xe9,0xea,0xf0,0x1c,0x21,0xb1,0x57,0x3f,0x6a,0x62,
		0x45,0x58,0xbe,0x73,0xb4,0x26,0xaf,0xd0,0x89,0xbe,0x6d,0x0e,0x98,0x07,0x03,0xe3,
		0x9a,0x5a,0xc8,0xf4,0xb5,0x4e,0xfe,0xd8,0x10,0x63,0xab,0x66,0x73,0x6e,0xb9,0x24,
		0xf5,0xf3,0x4e,0x9a,0x41,0xa4,0x55,0x7c,0x16,0x99,0x96,0x66,0xec,0x7c,0xd6,0x5c,
		0x8e,0x7e,0xcf,0x36,0xfd,0x71,0x65,0x2a,0x33,0xa5,0xd2,0xb5,0x14,0xb5,0x5c,0x4b,
		0xe4,0x21,0xab,0x9f,0x4a,0x1e,0xff,0x46,0x9e,0xfc,0x44,0x1f,0xae,0xd3,0x23,0x79,
		0xb7,0x2e,0x4b,0x25,0xc2,0x6a,0x00,0xdf,0xa6,0xa0,0xb6,0xcd,0xf7,0xc4,0xaa,0x4e,
		0xba,0xc4,0x53,0xba,0x61,0xcf,0x66,0x6c,0x31,0x4d,0xe0,0xa3,0x12,0xb2,0xd0,0xd8,
		0x88,0x97,0x4c,0x7c,0xcf,0xd8,0x43,0xfd,0x1f,0x0c,0x67,0x47,0x19,0xb5,0x62,0x90,
		0x1a,0xd1,0x4b,0xfa,0x8b,0xf6,0x34,0x7f,0xbf,0x4a,0xa2,0xf6,0xca,0x81,0x76,0x9e,
		0xe5,0xd3,0xed,0xef,0x92,0xc6,0xe4,0xd9,0x4c,0xf2,0x50,0x75,0xfa,0x11,0xb9,0x8a,
		0x98,0xa3,0xeb,0x22,0xfe,0x5d,0x44,0xad,0x27,0x4b,0xa6,0xfc,0xf4,0x3c,0x33,0x6a,
		0xbc,0x3a,0xf6,0xe1,0x27,0xb3,0x3e,0x6f,0x37,0x68,0x1c,0x71,0xe8,0x8d,0x6b,0xcf,
		0x55,0xeb,0xa7,0x7d,0xb6,0xaf,0xcd,0x6d,0x70,0xfa,0xf6,0x57,0xe4,0xf1,0x91,0xf5,
		0x49
};
const uint16_t CACertLen = sizeof(CACert);
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_I2C1_Init(void);
static void MX_I2S3_Init(void);
static void MX_SPI1_Init(void);
static void MX_CRC_Init(void);
static void MX_RNG_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

void transmitBuffer(uint8_t *data, uint16_t length) {
	// cely sendBuffer sa rozkuskuje na 64 bytove pakety ktore CDC_Transmit_FS vie preniest seriovo
	// Middlewares/ST/STM32_USB_Device_Library/Core/Inc/usbd_def.h
	// riadok 156 - #define USB_FS_MAX_PACKET_SIZE 64U - paket ma max velkost 64 bytov na transmit
    uint16_t sent = 0;
    while (sent < length) {
    	uint16_t chunk = (length - sent > 64) ? 64 : (length - sent);
    	while (CDC_Transmit_FS(data + sent, chunk) == USBD_BUSY) {
    		// cakame kym sa skonci prenos paketu
    	}
    	sent += chunk;
    }
}

void USBReceiveHandler() {
	if (messageCounter == 1) {
		uint8_t* receivedChars = malloc(4);
		memcpy(receivedChars, &receiveBuffer[0], 4);
		firstMessageHandler(receivedChars);
		free(receivedChars);
		messageCounter = 3;
	} else if (messageCounter == 3) {
		uint8_t* encryptedKey = malloc(256);
		uint8_t* encryptedIV = malloc(256);
		uint8_t* payload = malloc(512);
		uint16_t deviceCertLen = receiveCounter - 1024;
		uint8_t* deviceCertBuffer = malloc(deviceCertLen);
		memcpy(encryptedKey, &receiveBuffer[0], 256);
		memcpy(encryptedIV, &receiveBuffer[256], 256);
		memcpy(payload, &receiveBuffer[512], 512);
		memcpy(deviceCertBuffer, &receiveBuffer[1024], deviceCertLen);
		thirdMessageHandler(encryptedKey, encryptedIV, payload, deviceCertBuffer, deviceCertLen);
		free(encryptedKey);
		free(encryptedIV);
		free(payload);
		free(deviceCertBuffer);
		messageCounter = 5;
	} else {
		uint8_t* payload = malloc(512);
		uint8_t* sigHash = malloc(256);
		memcpy(payload, &receiveBuffer[0], 512);
		memcpy(sigHash, &receiveBuffer[512], 256);
		fifthMessageHandler(payload, sigHash);
		free(payload);
		free(sigHash);
		messageCounter = 1;
	}
	receiveCounter = 0;
	memset(&receiveBuffer, 0, sizeof(receiveBuffer));
	transmitBuffer(sendBuffer, sendCounter);
	sendCounter = 0;
	memset(&sendBuffer, 0, sizeof(sendBuffer));
}
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_I2C1_Init();
  MX_I2S3_Init();
  MX_SPI1_Init();
  MX_USB_DEVICE_Init();
  MX_CRC_Init();
  MX_RNG_Init();
  /* USER CODE BEGIN 2 */

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
	  if (dataReceivedFlag == 1) {
		  USBReceiveHandler();
		  dataReceivedFlag = 0;
	  }
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 8;
  RCC_OscInitStruct.PLL.PLLN = 336;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 7;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief CRC Initialization Function
  * @param None
  * @retval None
  */
static void MX_CRC_Init(void)
{

  /* USER CODE BEGIN CRC_Init 0 */

  /* USER CODE END CRC_Init 0 */

  /* USER CODE BEGIN CRC_Init 1 */

  /* USER CODE END CRC_Init 1 */
  hcrc.Instance = CRC;
  if (HAL_CRC_Init(&hcrc) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN CRC_Init 2 */

  /* USER CODE END CRC_Init 2 */

}

/**
  * @brief I2C1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2C1_Init(void)
{

  /* USER CODE BEGIN I2C1_Init 0 */

  /* USER CODE END I2C1_Init 0 */

  /* USER CODE BEGIN I2C1_Init 1 */

  /* USER CODE END I2C1_Init 1 */
  hi2c1.Instance = I2C1;
  hi2c1.Init.ClockSpeed = 100000;
  hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
  hi2c1.Init.OwnAddress1 = 0;
  hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
  hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
  hi2c1.Init.OwnAddress2 = 0;
  hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
  hi2c1.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
  if (HAL_I2C_Init(&hi2c1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2C1_Init 2 */

  /* USER CODE END I2C1_Init 2 */

}

/**
  * @brief I2S3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2S3_Init(void)
{

  /* USER CODE BEGIN I2S3_Init 0 */

  /* USER CODE END I2S3_Init 0 */

  /* USER CODE BEGIN I2S3_Init 1 */

  /* USER CODE END I2S3_Init 1 */
  hi2s3.Instance = SPI3;
  hi2s3.Init.Mode = I2S_MODE_MASTER_TX;
  hi2s3.Init.Standard = I2S_STANDARD_PHILIPS;
  hi2s3.Init.DataFormat = I2S_DATAFORMAT_16B;
  hi2s3.Init.MCLKOutput = I2S_MCLKOUTPUT_ENABLE;
  hi2s3.Init.AudioFreq = I2S_AUDIOFREQ_96K;
  hi2s3.Init.CPOL = I2S_CPOL_LOW;
  hi2s3.Init.ClockSource = I2S_CLOCK_PLL;
  hi2s3.Init.FullDuplexMode = I2S_FULLDUPLEXMODE_DISABLE;
  if (HAL_I2S_Init(&hi2s3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2S3_Init 2 */

  /* USER CODE END I2S3_Init 2 */

}

/**
  * @brief RNG Initialization Function
  * @param None
  * @retval None
  */
static void MX_RNG_Init(void)
{

  /* USER CODE BEGIN RNG_Init 0 */

  /* USER CODE END RNG_Init 0 */

  /* USER CODE BEGIN RNG_Init 1 */

  /* USER CODE END RNG_Init 1 */
  hrng.Instance = RNG;
  if (HAL_RNG_Init(&hrng) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN RNG_Init 2 */

  /* USER CODE END RNG_Init 2 */

}

/**
  * @brief SPI1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI1_Init(void)
{

  /* USER CODE BEGIN SPI1_Init 0 */

  /* USER CODE END SPI1_Init 0 */

  /* USER CODE BEGIN SPI1_Init 1 */

  /* USER CODE END SPI1_Init 1 */
  /* SPI1 parameter configuration*/
  hspi1.Instance = SPI1;
  hspi1.Init.Mode = SPI_MODE_MASTER;
  hspi1.Init.Direction = SPI_DIRECTION_2LINES;
  hspi1.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi1.Init.NSS = SPI_NSS_SOFT;
  hspi1.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_2;
  hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi1.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi1.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi1.Init.CRCPolynomial = 10;
  if (HAL_SPI_Init(&hspi1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI1_Init 2 */

  /* USER CODE END SPI1_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  /* USER CODE BEGIN MX_GPIO_Init_1 */

  /* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOE_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(CS_I2C_SPI_GPIO_Port, CS_I2C_SPI_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(OTG_FS_PowerSwitchOn_GPIO_Port, OTG_FS_PowerSwitchOn_Pin, GPIO_PIN_SET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOD, LD4_Pin|LD3_Pin|LD5_Pin|LD6_Pin
                          |Audio_RST_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin : CS_I2C_SPI_Pin */
  GPIO_InitStruct.Pin = CS_I2C_SPI_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(CS_I2C_SPI_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : OTG_FS_PowerSwitchOn_Pin */
  GPIO_InitStruct.Pin = OTG_FS_PowerSwitchOn_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(OTG_FS_PowerSwitchOn_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : PDM_OUT_Pin */
  GPIO_InitStruct.Pin = PDM_OUT_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI2;
  HAL_GPIO_Init(PDM_OUT_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : B1_Pin */
  GPIO_InitStruct.Pin = B1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_EVT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(B1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : BOOT1_Pin */
  GPIO_InitStruct.Pin = BOOT1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(BOOT1_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : CLK_IN_Pin */
  GPIO_InitStruct.Pin = CLK_IN_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI2;
  HAL_GPIO_Init(CLK_IN_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : LD4_Pin LD3_Pin LD5_Pin LD6_Pin
                           Audio_RST_Pin */
  GPIO_InitStruct.Pin = LD4_Pin|LD3_Pin|LD5_Pin|LD6_Pin
                          |Audio_RST_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pin : OTG_FS_OverCurrent_Pin */
  GPIO_InitStruct.Pin = OTG_FS_OverCurrent_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_INPUT;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(OTG_FS_OverCurrent_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : MEMS_INT2_Pin */
  GPIO_InitStruct.Pin = MEMS_INT2_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_EVT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(MEMS_INT2_GPIO_Port, &GPIO_InitStruct);

  /* USER CODE BEGIN MX_GPIO_Init_2 */

  /* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
